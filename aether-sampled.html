<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aether Pro — Sampled Instruments</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Mono:wght@300;400&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --accent: #00ffc8;
    --accent2: #ff3366;
    --accent3: #7b61ff;
    --text: #e8e8f0;
    --text-dim: #555568;
    --glow: 0 0 40px rgba(0, 255, 200, 0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 32px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    z-index: 10;
  }

  .logo {
    font-family: 'Instrument Serif', serif;
    font-size: 28px;
    font-style: italic;
    letter-spacing: 0.02em;
    background: linear-gradient(135deg, var(--accent2), var(--accent3));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .logo-tag {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: var(--accent2);
    margin-left: 10px;
    opacity: 0.6;
  }

  .status {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text-dim);
    transition: background 0.3s;
  }

  .status-dot.active {
    background: var(--accent);
    box-shadow: 0 0 8px var(--accent);
  }

  .main-area {
    flex: 1;
    display: flex;
    position: relative;
    overflow: hidden;
  }

  .video-container {
    position: relative;
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  video, .overlay-canvas {
    position: absolute;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  video {
    transform: scaleX(-1);
    opacity: 0.25;
    filter: grayscale(0.6) contrast(1.1);
  }

  .overlay-canvas {
    transform: scaleX(-1);
    z-index: 2;
  }

  .viz-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
    pointer-events: none;
  }

  .start-overlay {
    position: absolute;
    inset: 0;
    z-index: 20;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(10, 10, 15, 0.92);
    backdrop-filter: blur(20px);
    transition: opacity 0.6s ease, visibility 0.6s;
  }

  .start-overlay.hidden {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
  }

  .start-title {
    font-family: 'Instrument Serif', serif;
    font-style: italic;
    font-size: clamp(48px, 8vw, 96px);
    background: linear-gradient(135deg, var(--accent2), var(--accent3));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 16px;
  }

  .start-sub {
    font-size: 13px;
    color: var(--text-dim);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 48px;
  }

  .start-btn {
    background: none;
    border: 1px solid rgba(255,255,255,0.12);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 16px 48px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.3s;
  }

  .start-btn:hover {
    border-color: var(--accent2);
    color: var(--accent2);
    box-shadow: 0 0 40px rgba(255, 51, 102, 0.15);
  }

  .start-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,51,102,0.05), rgba(123,97,255,0.05));
    opacity: 0;
    transition: opacity 0.3s;
  }

  .start-btn:hover::before { opacity: 1; }

  .side-panel {
    width: 280px;
    background: var(--surface);
    border-left: 1px solid rgba(255,255,255,0.04);
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 24px;
    z-index: 5;
    overflow-y: auto;
  }

  .panel-section h3 {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: var(--text-dim);
    margin-bottom: 14px;
  }

  .param-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .param-label {
    font-size: 12px;
    color: var(--text-dim);
  }

  .param-value {
    font-size: 12px;
    color: var(--accent);
    font-variant-numeric: tabular-nums;
    min-width: 60px;
    text-align: right;
  }

  .meter-bar {
    width: 100%;
    height: 3px;
    background: rgba(255,255,255,0.04);
    border-radius: 2px;
    margin-top: 4px;
    overflow: hidden;
  }

  .meter-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.08s ease-out;
    background: linear-gradient(90deg, var(--accent), var(--accent3));
  }

  .selector-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .sel-btn {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    padding: 6px 12px;
    border: 1px solid rgba(255,255,255,0.06);
    background: none;
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.2s;
  }

  .sel-btn.active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0,255,200,0.05);
  }

  .sel-btn:hover:not(.active) {
    border-color: rgba(255,255,255,0.15);
    color: var(--text);
  }

  .sel-btn.inst.active {
    border-color: var(--accent2);
    color: var(--accent2);
    background: rgba(255,51,102,0.05);
  }

  .sel-btn.loading {
    opacity: 0.4;
    pointer-events: none;
  }

  .instructions {
    font-size: 11px;
    line-height: 1.7;
    color: var(--text-dim);
  }

  .instructions em {
    color: var(--accent);
    font-style: normal;
  }

  .instructions .dim-em {
    color: var(--accent3);
    font-style: normal;
  }

  .note-display {
    position: absolute;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    text-align: center;
    pointer-events: none;
  }

  .current-note {
    font-family: 'Instrument Serif', serif;
    font-style: italic;
    font-size: 64px;
    color: var(--accent);
    text-shadow: 0 0 40px rgba(0,255,200,0.3);
    opacity: 0;
    transition: opacity 0.15s;
  }

  .current-note.visible { opacity: 1; }

  .current-freq {
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 0.1em;
    margin-top: 4px;
  }

  .grain-overlay {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 100;
    opacity: 0.03;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  }

  @keyframes pulse {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 1; }
  }

  .loading .status-dot {
    animation: pulse 1.5s ease-in-out infinite;
  }
</style>
</head>
<body>
<div class="grain-overlay"></div>

<header>
  <div style="display:flex;align-items:baseline">
    <div class="logo">Aether</div>
    <span class="logo-tag">Sampled</span>
  </div>
  <div class="status" id="statusBar">
    <span class="status-dot" id="statusDot"></span>
    <span id="statusText">awaiting camera</span>
  </div>
</header>

<div class="main-area">
  <div class="video-container">
    <video id="webcam" autoplay playsinline></video>
    <canvas class="viz-canvas" id="vizCanvas"></canvas>
    <canvas class="overlay-canvas" id="overlayCanvas"></canvas>

    <div class="start-overlay" id="startOverlay">
      <div class="start-title">Aether</div>
      <div class="start-sub">Gesture-Controlled Sampled Instruments</div>
      <button class="start-btn" id="startBtn">Begin Session</button>
    </div>

    <div class="note-display">
      <div class="current-note" id="noteDisplay">&mdash;</div>
      <div class="current-freq" id="freqDisplay"></div>
    </div>
  </div>

  <div class="side-panel">
    <div class="panel-section">
      <h3>How to Play</h3>
      <div class="instructions">
        <em>Right hand</em> &uarr;&darr; selects note &nbsp; <span class="dim-em">&larr;&rarr; tremolo</span><br><br>
        <em>Left hand</em> &uarr;&darr; volume &nbsp; <span class="dim-em">&larr;&rarr; brightness</span><br><br>
        <em>Pinch</em> thumb + index to mute
      </div>
    </div>

    <div class="panel-section">
      <h3>Live Data</h3>
      <div class="param-row">
        <span class="param-label">Note</span>
        <span class="param-value" id="noteValue">&mdash;</span>
      </div>
      <div class="meter-bar"><div class="meter-fill" id="pitchMeter" style="width:0%"></div></div>

      <div class="param-row" style="margin-top:14px">
        <span class="param-label">Volume</span>
        <span class="param-value" id="volValue">&mdash;</span>
      </div>
      <div class="meter-bar"><div class="meter-fill" id="volMeter" style="width:0%"></div></div>

      <div class="param-row" style="margin-top:14px">
        <span class="param-label">Tremolo</span>
        <span class="param-value" id="tremValue">&mdash;</span>
      </div>
      <div class="meter-bar"><div class="meter-fill" id="tremMeter" style="width:0%"></div></div>

      <div class="param-row" style="margin-top:14px">
        <span class="param-label">Filter</span>
        <span class="param-value" id="filterValue">&mdash;</span>
      </div>
      <div class="meter-bar"><div class="meter-fill" id="filterMeter" style="width:0%"></div></div>
    </div>

    <div class="panel-section">
      <h3>Instrument</h3>
      <div class="selector-grid" id="instSelector">
        <button class="sel-btn inst active" data-inst="piano">Piano</button>
        <button class="sel-btn inst" data-inst="guitar">E. Guitar</button>
        <button class="sel-btn inst" data-inst="acoustic">Acoustic</button>
        <button class="sel-btn inst" data-inst="violin">Violin</button>
        <button class="sel-btn inst" data-inst="sax">Saxophone</button>
        <button class="sel-btn inst" data-inst="pluck">Pluck</button>
        <button class="sel-btn inst" data-inst="fmkeys">FM Keys</button>
      </div>
    </div>

    <div class="panel-section">
      <h3>Scale</h3>
      <div class="selector-grid" id="scaleSelector">
        <button class="sel-btn active" data-scale="chromatic">Chromatic</button>
        <button class="sel-btn" data-scale="pentatonic">Pentatonic</button>
        <button class="sel-btn" data-scale="major">Major</button>
        <button class="sel-btn" data-scale="minor">Minor</button>
        <button class="sel-btn" data-scale="blues">Blues</button>
        <button class="sel-btn" data-scale="dorian">Dorian</button>
      </div>
    </div>
  </div>
</div>

<!-- MediaPipe Hands -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469240/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1675466862/camera_utils.min.js"></script>
<!-- Tone.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

<script>
(function() {
  // === DOM Elements ===
  const videoEl = document.getElementById('webcam');
  const overlayCanvas = document.getElementById('overlayCanvas');
  const vizCanvas = document.getElementById('vizCanvas');
  const overlayCtx = overlayCanvas.getContext('2d');
  const vizCtx = vizCanvas.getContext('2d');
  const startOverlay = document.getElementById('startOverlay');
  const startBtn = document.getElementById('startBtn');
  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  const statusBar = document.getElementById('statusBar');
  const noteDisplay = document.getElementById('noteDisplay');
  const freqDisplay = document.getElementById('freqDisplay');
  const noteValue = document.getElementById('noteValue');
  const volValue = document.getElementById('volValue');
  const pitchMeter = document.getElementById('pitchMeter');
  const volMeter = document.getElementById('volMeter');
  const tremValue = document.getElementById('tremValue');
  const tremMeter = document.getElementById('tremMeter');
  const filterValue = document.getElementById('filterValue');
  const filterMeter = document.getElementById('filterMeter');

  // === Musical Scales ===
  const SCALES = {
    chromatic:  [0,1,2,3,4,5,6,7,8,9,10,11],
    pentatonic: [0,2,4,7,9],
    major:      [0,2,4,5,7,9,11],
    minor:      [0,2,3,5,7,8,10],
    blues:      [0,3,5,6,7,10],
    dorian:     [0,2,3,5,7,9,10]
  };

  const NOTE_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

  // === Instrument Presets ===
  const IOWA_BASE = 'https://nbrosowsky.github.io/tonejs-instruments/samples/';
  const GLEITZ_BASE = 'https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/';

  const INSTRUMENTS = {
    piano: {
      type: 'sampler',
      label: 'Piano',
      baseUrl: IOWA_BASE + 'piano/',
      urls: {
        'C3': 'C3.mp3', 'E3': 'E3.mp3', 'A3': 'A3.mp3',
        'C4': 'C4.mp3', 'E4': 'E4.mp3', 'A4': 'A4.mp3',
        'C5': 'C5.mp3', 'E5': 'E5.mp3', 'A5': 'A5.mp3',
        'C6': 'C6.mp3'
      },
      release: 1.5,
      effects: { filterFreq: 5000, filterQ: 1, reverbWet: 0.25, delayWet: 0.1, delayFeedback: 0.1, delayTime: 0.25 }
    },
    guitar: {
      type: 'sampler',
      label: 'E. Guitar',
      baseUrl: GLEITZ_BASE + 'electric_guitar_clean-mp3/',
      urls: {
        'E2': 'E2.mp3', 'G2': 'G2.mp3', 'Bb2': 'Bb2.mp3',
        'C3': 'C3.mp3', 'Eb3': 'Eb3.mp3', 'Gb3': 'Gb3.mp3', 'A3': 'A3.mp3',
        'C4': 'C4.mp3', 'Eb4': 'Eb4.mp3', 'Gb4': 'Gb4.mp3', 'A4': 'A4.mp3',
        'C5': 'C5.mp3'
      },
      release: 0.3,
      effects: { filterFreq: 3500, filterQ: 2, reverbWet: 0.15, delayWet: 0.15, delayFeedback: 0.15, delayTime: 0.2 }
    },
    acoustic: {
      type: 'sampler',
      label: 'Acoustic',
      baseUrl: GLEITZ_BASE + 'acoustic_guitar_steel-mp3/',
      urls: {
        'E2': 'E2.mp3', 'G2': 'G2.mp3', 'Bb2': 'Bb2.mp3',
        'C3': 'C3.mp3', 'Eb3': 'Eb3.mp3', 'G3': 'G3.mp3', 'A3': 'A3.mp3',
        'C4': 'C4.mp3', 'Eb4': 'Eb4.mp3', 'G4': 'G4.mp3', 'A4': 'A4.mp3',
        'C5': 'C5.mp3'
      },
      release: 0.4,
      effects: { filterFreq: 4500, filterQ: 1, reverbWet: 0.2, delayWet: 0.1, delayFeedback: 0.1, delayTime: 0.2 }
    },
    violin: {
      type: 'sampler',
      label: 'Violin',
      baseUrl: IOWA_BASE + 'violin/',
      urls: {
        'G3': 'G3.mp3', 'C4': 'C4.mp3', 'E4': 'E4.mp3', 'A4': 'A4.mp3',
        'C5': 'C5.mp3', 'E5': 'E5.mp3', 'A5': 'A5.mp3', 'C6': 'C6.mp3'
      },
      release: 0.5,
      effects: { filterFreq: 5000, filterQ: 1, reverbWet: 0.3, delayWet: 0.1, delayFeedback: 0.1, delayTime: 0.15 }
    },
    sax: {
      type: 'sampler',
      label: 'Saxophone',
      baseUrl: IOWA_BASE + 'saxophone/',
      urls: {
        'D3': 'D3.mp3', 'F3': 'F3.mp3', 'G#3': 'Gs3.mp3', 'B3': 'B3.mp3',
        'D4': 'D4.mp3', 'F4': 'F4.mp3', 'G#4': 'Gs4.mp3', 'B4': 'B4.mp3',
        'D5': 'D5.mp3', 'F5': 'F5.mp3'
      },
      release: 0.3,
      effects: { filterFreq: 4000, filterQ: 1.5, reverbWet: 0.2, delayWet: 0.12, delayFeedback: 0.15, delayTime: 0.2 }
    },
    pluck: {
      type: 'synth',
      label: 'Pluck',
      create: () => new Tone.PluckSynth({ attackNoise: 1, dampening: 4000, resonance: 0.95 }),
      effects: { filterFreq: 5000, filterQ: 1, reverbWet: 0.25, delayWet: 0.2, delayFeedback: 0.2, delayTime: 0.2 }
    },
    fmkeys: {
      type: 'synth',
      label: 'FM Keys',
      create: () => new Tone.FMSynth({
        harmonicity: 3.01,
        modulationIndex: 10,
        oscillator: { type: 'sine' },
        envelope: { attack: 0.01, decay: 0.4, sustain: 0.2, release: 0.8 },
        modulation: { type: 'square' },
        modulationEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.5 }
      }),
      effects: { filterFreq: 4000, filterQ: 1, reverbWet: 0.3, delayWet: 0.15, delayFeedback: 0.1, delayTime: 0.2 }
    }
  };

  // === State ===
  let currentScale = 'chromatic';
  let currentInstrument = 'piano';
  let isPlaying = false;
  let instrumentLoaded = false;
  let currentNote = null;
  let shouldPlay = false;

  // === Audio Nodes ===
  let instrument = null;
  let gainNode, tremolo, filter, delay, reverb;
  let baseFilterFreq = 5000;

  // === Smoothing ===
  const smoothFreq = { value: 440, target: 440 };
  const smoothVol = { value: 0, target: 0 };
  const smoothTremolo = { value: 0, target: 0 };
  const smoothFilter = { value: 0.5, target: 0.5 };
  const SMOOTH = 0.12;

  function lerp(a, b, t) { return a + (b - a) * t; }

  // === Audio Setup ===
  function initAudio() {
    reverb = new Tone.Reverb({ decay: 5, wet: 0.25 }).toDestination();
    delay = new Tone.FeedbackDelay({ delayTime: 0.25, feedback: 0.15, wet: 0.15 }).connect(reverb);
    filter = new Tone.Filter({ frequency: 5000, type: 'lowpass', rolloff: -12 }).connect(delay);
    gainNode = new Tone.Gain(0).connect(filter);
    tremolo = new Tone.Tremolo({ frequency: 5, depth: 0, wet: 1, type: 'sine' }).connect(gainNode).start();
  }

  async function loadInstrument(name) {
    instrumentLoaded = false;
    const config = INSTRUMENTS[name];
    if (!config) return;

    // Release current note
    if (currentNote && instrument) {
      try { instrument.triggerRelease(currentNote); } catch(e) {
        try { instrument.triggerRelease(); } catch(e2) {}
      }
      currentNote = null;
    }

    // Dispose old instrument
    if (instrument) {
      try { instrument.disconnect(); } catch(e) {}
      try { instrument.dispose(); } catch(e) {}
      instrument = null;
    }

    statusText.textContent = 'loading ' + config.label + '...';
    statusBar.classList.add('loading');

    // Disable all instrument buttons during load
    document.querySelectorAll('#instSelector .sel-btn').forEach(b => b.classList.add('loading'));

    try {
      if (config.type === 'sampler') {
        instrument = await new Promise((resolve, reject) => {
          const timeout = setTimeout(() => reject(new Error('Sample load timeout')), 20000);
          const s = new Tone.Sampler({
            urls: config.urls,
            baseUrl: config.baseUrl,
            release: config.release || 1,
            onload: () => { clearTimeout(timeout); resolve(s); }
          }).connect(tremolo);
        });
      } else {
        instrument = config.create().connect(tremolo);
      }

      // Apply effects
      baseFilterFreq = config.effects.filterFreq;
      filter.frequency.value = config.effects.filterFreq;
      filter.Q.value = config.effects.filterQ;
      reverb.wet.value = config.effects.reverbWet;
      delay.delayTime.value = config.effects.delayTime;
      delay.feedback.value = config.effects.delayFeedback;
      delay.wet.value = config.effects.delayWet;

      currentInstrument = name;
      instrumentLoaded = true;
      statusText.textContent = 'tracking';
      statusBar.classList.remove('loading');
    } catch(err) {
      console.error('Failed to load instrument:', err);
      statusText.textContent = 'load failed \u2014 try another';
      statusBar.classList.remove('loading');
    }

    // Re-enable buttons
    document.querySelectorAll('#instSelector .sel-btn').forEach(b => b.classList.remove('loading'));
  }

  // === Quantize frequency to scale (always snaps to a semitone) ===
  function quantizeToScale(freq, scale) {
    const intervals = SCALES[scale];
    const midiNote = 12 * Math.log2(freq / 440) + 69;
    const roundedMidi = Math.round(midiNote);

    if (scale === 'chromatic') {
      return 440 * Math.pow(2, (roundedMidi - 69) / 12);
    }

    const noteInOctave = ((roundedMidi % 12) + 12) % 12;
    const octave = Math.floor(roundedMidi / 12) - 1;

    let closest = intervals[0];
    let minDist = 99;
    for (const interval of intervals) {
      const dist = Math.min(
        Math.abs(noteInOctave - interval),
        12 - Math.abs(noteInOctave - interval)
      );
      if (dist < minDist) {
        minDist = dist;
        closest = interval;
      }
    }

    const quantizedMidi = (octave + 1) * 12 + closest;
    return 440 * Math.pow(2, (quantizedMidi - 69) / 12);
  }

  function freqToNoteName(freq) {
    const midi = Math.round(12 * Math.log2(freq / 440) + 69);
    const name = NOTE_NAMES[((midi % 12) + 12) % 12];
    const oct = Math.floor(midi / 12) - 1;
    return name + oct;
  }

  // === Gesture detection ===
  function getPinchDistance(landmarks) {
    const thumb = landmarks[4];
    const index = landmarks[8];
    const dx = thumb.x - index.x;
    const dy = thumb.y - index.y;
    return Math.sqrt(dx * dx + dy * dy);
  }

  // === Viz particles ===
  let particles = [];
  const MAX_PARTICLES = 60;

  function spawnParticle(x, y, hue) {
    if (particles.length > MAX_PARTICLES) particles.shift();
    particles.push({
      x, y,
      vx: (Math.random() - 0.5) * 2,
      vy: (Math.random() - 0.5) * 2 - 1,
      life: 1,
      size: Math.random() * 4 + 2,
      hue
    });
  }

  // === Drawing ===
  function drawHand(landmarks, label, w, h) {
    const connections = [
      [0,1],[1,2],[2,3],[3,4],
      [0,5],[5,6],[6,7],[7,8],
      [0,9],[9,10],[10,11],[11,12],
      [0,13],[13,14],[14,15],[15,16],
      [0,17],[17,18],[18,19],[19,20],
      [5,9],[9,13],[13,17]
    ];

    const isRight = label === 'Right';
    const color = isRight ? 'rgba(0,255,200,' : 'rgba(123,97,255,';

    overlayCtx.lineWidth = 1.5;
    for (const [a, b] of connections) {
      const pa = landmarks[a];
      const pb = landmarks[b];
      overlayCtx.strokeStyle = color + '0.3)';
      overlayCtx.beginPath();
      overlayCtx.moveTo(pa.x * w, pa.y * h);
      overlayCtx.lineTo(pb.x * w, pb.y * h);
      overlayCtx.stroke();
    }

    for (let i = 0; i < landmarks.length; i++) {
      const lm = landmarks[i];
      const px = lm.x * w;
      const py = lm.y * h;
      const r = (i === 4 || i === 8) ? 5 : 2.5;

      overlayCtx.fillStyle = color + '0.7)';
      overlayCtx.beginPath();
      overlayCtx.arc(px, py, r, 0, Math.PI * 2);
      overlayCtx.fill();

      if (i === 8) {
        const grad = overlayCtx.createRadialGradient(px, py, 0, px, py, 20);
        grad.addColorStop(0, color + '0.4)');
        grad.addColorStop(1, color + '0)');
        overlayCtx.fillStyle = grad;
        overlayCtx.beginPath();
        overlayCtx.arc(px, py, 20, 0, Math.PI * 2);
        overlayCtx.fill();

        spawnParticle(px, py, isRight ? 165 : 260);
      }
    }
  }

  function drawViz(w, h) {
    vizCtx.clearRect(0, 0, w, h);

    for (let i = particles.length - 1; i >= 0; i--) {
      const p = particles[i];
      p.x += p.vx;
      p.y += p.vy;
      p.life -= 0.02;
      if (p.life <= 0) { particles.splice(i, 1); continue; }

      vizCtx.globalAlpha = p.life * 0.5;
      vizCtx.fillStyle = `hsla(${p.hue}, 100%, 70%, ${p.life})`;
      vizCtx.beginPath();
      vizCtx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
      vizCtx.fill();
    }
    vizCtx.globalAlpha = 1;

    // Note step indicator lines
    if (isPlaying && currentNote && smoothVol.value > 0.01) {
      const freq = smoothFreq.value;
      const pitchNorm = Math.log2(freq / 130.81) / Math.log2(1046.50 / 130.81);
      const noteY = h * (1 - Math.max(0, Math.min(1, pitchNorm)));

      vizCtx.strokeStyle = `rgba(255, 51, 102, ${smoothVol.value * 0.2})`;
      vizCtx.lineWidth = 1;
      vizCtx.setLineDash([4, 8]);
      vizCtx.beginPath();
      vizCtx.moveTo(0, noteY);
      vizCtx.lineTo(w, noteY);
      vizCtx.stroke();
      vizCtx.setLineDash([]);
    }
  }

  // === MediaPipe Hands ===
  let hands;
  let camera;

  function initMediaPipe() {
    hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469240/${file}`
    });

    hands.setOptions({
      maxNumHands: 2,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.6
    });

    hands.onResults(onResults);
  }

  function onResults(results) {
    const w = overlayCanvas.width;
    const h = overlayCanvas.height;
    overlayCtx.clearRect(0, 0, w, h);

    let rightHand = null;
    let leftHand = null;

    if (results.multiHandLandmarks && results.multiHandedness) {
      for (let i = 0; i < results.multiHandLandmarks.length; i++) {
        const landmarks = results.multiHandLandmarks[i];
        const label = results.multiHandedness[i].label;
        if (label === 'Left') {
          rightHand = landmarks;
          drawHand(landmarks, 'Right', w, h);
        } else {
          leftHand = landmarks;
          drawHand(landmarks, 'Left', w, h);
        }
      }
    }

    // === Right hand: pitch (Y) + tremolo (X) ===
    if (rightHand) {
      const indexTip = rightHand[8];
      const pinchDist = getPinchDistance(rightHand);
      const isPinched = pinchDist < 0.05;

      const pitchNorm = 1 - Math.max(0, Math.min(1, indexTip.y));
      const minFreq = 130.81;
      const maxFreq = 1046.50;
      const rawFreq = minFreq * Math.pow(maxFreq / minFreq, pitchNorm);

      smoothFreq.target = isPinched ? smoothFreq.value : rawFreq;
      shouldPlay = !isPinched;

      // X → tremolo depth
      const tremNorm = Math.max(0, Math.min(1, indexTip.x * 1.5));
      smoothTremolo.target = isPinched ? 0 : tremNorm;

      if (!leftHand) {
        smoothVol.target = isPinched ? 0 : 0.5;
      }
    } else {
      shouldPlay = false;
      smoothVol.target = 0;
      smoothTremolo.target = 0;
    }

    // === Left hand: volume (Y) + filter brightness (X) ===
    if (leftHand) {
      const indexTip = leftHand[8];
      const pinchDist = getPinchDistance(leftHand);
      const isPinched = pinchDist < 0.05;

      const volNorm = 1 - Math.max(0, Math.min(1, indexTip.y));
      smoothVol.target = isPinched ? 0 : volNorm * 0.7;
      if (isPinched) shouldPlay = false;

      const filterNorm = Math.max(0, Math.min(1, (1 - indexTip.x) * 1.5));
      smoothFilter.target = isPinched ? 0.5 : filterNorm;
    } else if (!rightHand) {
      smoothFilter.target = 0.5;
    }

    drawViz(w, h);
  }

  // === Audio loop: smooth values + trigger discrete notes ===
  function audioLoop() {
    if (!instrumentLoaded || !instrument) {
      requestAnimationFrame(audioLoop);
      return;
    }

    // Smooth all values
    smoothFreq.value = lerp(smoothFreq.value, smoothFreq.target, SMOOTH);
    smoothVol.value = lerp(smoothVol.value, smoothVol.target, SMOOTH);
    smoothTremolo.value = lerp(smoothTremolo.value, smoothTremolo.target, SMOOTH);
    smoothFilter.value = lerp(smoothFilter.value, smoothFilter.target, SMOOTH);

    // Quantize to scale note
    const outputFreq = quantizeToScale(smoothFreq.value, currentScale);
    const noteName = freqToNoteName(outputFreq);

    // === Discrete note triggering ===
    if (shouldPlay && smoothVol.value > 0.02) {
      if (noteName !== currentNote) {
        // Release old note
        if (currentNote) {
          try { instrument.triggerRelease(currentNote); } catch(e) {
            try { instrument.triggerRelease(); } catch(e2) {}
          }
        }
        currentNote = noteName;
        try { instrument.triggerAttack(noteName); } catch(e) {
          console.warn('triggerAttack failed:', e);
        }
      }
    } else {
      // Mute: release current note
      if (currentNote) {
        try { instrument.triggerRelease(currentNote); } catch(e) {
          try { instrument.triggerRelease(); } catch(e2) {}
        }
        currentNote = null;
      }
    }

    // Volume
    gainNode.gain.value = smoothVol.value;

    // Tremolo
    tremolo.depth.value = smoothTremolo.value * 0.7;
    tremolo.frequency.value = 3 + smoothTremolo.value * 6;

    // Filter
    const filterMultiplier = Math.pow(4, smoothFilter.value * 2 - 1);
    filter.frequency.value = baseFilterFreq * filterMultiplier;

    // === Update display ===
    if (smoothVol.value > 0.01 && currentNote) {
      const pitchNorm = Math.log2(outputFreq / 130.81) / Math.log2(1046.50 / 130.81);

      noteValue.textContent = noteName;
      pitchMeter.style.width = (Math.max(0, Math.min(1, pitchNorm)) * 100) + '%';
      noteDisplay.textContent = noteName.replace(/\d/, '');
      noteDisplay.classList.add('visible');
      freqDisplay.textContent = Math.round(outputFreq) + ' Hz';

      volValue.textContent = Math.round(smoothVol.value / 0.7 * 100) + '%';
      volMeter.style.width = (smoothVol.value / 0.7 * 100) + '%';
    } else {
      noteDisplay.classList.remove('visible');
      noteValue.textContent = '\u2014';
      freqDisplay.textContent = '';
      volValue.textContent = '\u2014';
      volMeter.style.width = '0%';
    }

    const tremPct = Math.round(smoothTremolo.value * 100);
    tremValue.textContent = tremPct > 0 ? tremPct + '%' : '\u2014';
    tremMeter.style.width = tremPct + '%';

    const filterHz = Math.round(filter.frequency.value);
    filterValue.textContent = filterHz > 0 ? filterHz + ' Hz' : '\u2014';
    filterMeter.style.width = Math.max(0, Math.min(100, smoothFilter.value * 100)) + '%';

    requestAnimationFrame(audioLoop);
  }

  // === Resize ===
  function resize() {
    const container = document.querySelector('.video-container');
    const w = container.clientWidth;
    const h = container.clientHeight;
    overlayCanvas.width = w;
    overlayCanvas.height = h;
    vizCanvas.width = w;
    vizCanvas.height = h;
  }

  window.addEventListener('resize', resize);

  // === Scale buttons ===
  document.getElementById('scaleSelector').addEventListener('click', (e) => {
    const btn = e.target.closest('.sel-btn');
    if (!btn || !btn.dataset.scale) return;
    document.querySelectorAll('#scaleSelector .sel-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentScale = btn.dataset.scale;
  });

  // === Instrument buttons ===
  document.getElementById('instSelector').addEventListener('click', async (e) => {
    const btn = e.target.closest('.sel-btn');
    if (!btn || !btn.dataset.inst || btn.classList.contains('loading')) return;
    if (btn.dataset.inst === currentInstrument && instrumentLoaded) return;

    document.querySelectorAll('#instSelector .sel-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    if (isPlaying) {
      await loadInstrument(btn.dataset.inst);
    } else {
      currentInstrument = btn.dataset.inst;
    }
  });

  // === Start ===
  startBtn.addEventListener('click', async () => {
    startOverlay.classList.add('hidden');
    statusBar.classList.add('loading');
    statusText.textContent = 'initializing...';

    await Tone.start();
    initAudio();
    initMediaPipe();

    resize();

    // Load default instrument (piano)
    await loadInstrument(currentInstrument);

    try {
      camera = new Camera(videoEl, {
        onFrame: async () => {
          await hands.send({ image: videoEl });
        },
        width: 1280,
        height: 720
      });

      await camera.start();

      statusDot.classList.add('active');
      statusBar.classList.remove('loading');
      statusText.textContent = 'tracking';
      isPlaying = true;

      audioLoop();
    } catch(err) {
      statusText.textContent = 'camera error';
      console.error(err);
    }
  });
})();
</script>
</body>
</html>